# å¤©ç¿¼äº‘ç›˜è‡ªåŠ¨ç­¾åˆ°ä¸Žé¡µé¢éƒ¨ç½² - ç»Ÿä¸€ç‰ˆ
name: å¤©ç¿¼äº‘ç›˜ç­¾åˆ°

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '30 1,13 * * *'  # ç­¾åˆ°æ—¶é—´ï¼šæ¯å¤© 09:30 å’Œ 21:30 (UTC+8)
    - cron: '35 5,17 * * *'  # é¡µé¢æ›´æ–°æ—¶é—´
  workflow_dispatch:
    inputs:
      task_type:
        description: 'é€‰æ‹©æ‰§è¡Œä»»åŠ¡'
        required: true
        default: 'both'
        type: choice
        options:
          - 'checkin'
          - 'pages'
          - 'both'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ç­¾åˆ°ä»»åŠ¡
  checkin:
    if: |
      github.event_name == 'schedule' && github.event.schedule == '30 1,13 * * *' ||
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'watch' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.task_type == 'checkin' || github.event.inputs.task_type == 'both'))
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
      PYTHONUNBUFFERED: 1
    outputs:
      checkin_success: ${{ steps.checkin.outputs.success }}
      pages_updated: ${{ steps.checkin.outputs.pages_updated }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Display IP address
        run: |
          echo "å½“å‰IPåœ°å€: $(curl -s https://ipinfo.io/ip)"

      - name: Run checkin script
        id: checkin
        run: |
          echo "å¼€å§‹æ‰§è¡Œç­¾åˆ°ä»»åŠ¡..."
          echo "æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          
          # æ‰§è¡Œç­¾åˆ°å¹¶ç”Ÿæˆé¡µé¢å†…å®¹
          {
            echo "# å¤©ç¿¼äº‘ç›˜ç­¾åˆ°è®°å½•"
            echo ""
            echo "**æœ€åŽæ›´æ–°:** $(date '+%Y-%m-%d %H:%M:%S %Z')"
            echo ""
            echo "**ç­¾åˆ°çŠ¶æ€:** [![ç­¾åˆ°çŠ¶æ€](https://github.com/${{ github.repository }}/actions/workflows/main.yml/badge.svg)](https://github.com/${{ github.repository }}/actions)"
            echo ""
            echo "## ðŸ“Š ç­¾åˆ°è¯¦æƒ…"
            echo ""
            python3 ./main.py 2>&1 | sed 's/^/- /'
            echo ""
            echo "---"
            echo "*ç”± GitHub Actions è‡ªåŠ¨æ›´æ–° â€¢ [æŸ¥çœ‹è¯¦ç»†æ—¥å¿—](https://github.com/${{ github.repository }}/actions)*"
          } | tee index.md
          
          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "pages_updated=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "pages_updated=false" >> $GITHUB_OUTPUT
          fi
        env:
          TYYP_USERNAME: ${{ secrets.TYYP_USERNAME }}
          TYYP_PSW: ${{ secrets.TYYP_PSW }}

      - name: Update log file
        if: always()
        run: |
          {
            echo "## $(date '+%Y-%m-%d %H:%M:%S') - ç­¾åˆ°è®°å½•"
            echo ""
            if [ "${{ steps.checkin.outputs.success }}" == "true" ]; then
              echo "âœ… **çŠ¶æ€:** ç­¾åˆ°æˆåŠŸ"
            else
              echo "âŒ **çŠ¶æ€:** ç­¾åˆ°å¤±è´¥"
            fi
            echo ""
            echo "**è¯¦æƒ…:**"
            cat index.md | tail -n +7 | head -n -3
            echo ""
            echo "---"
            echo ""
            if [ -f log.md ]; then
              tail -n +1 log.md
            fi
          } > log.md.tmp && mv log.md.tmp log.md

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– è‡ªåŠ¨ç­¾åˆ°æ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S')"
          file_pattern: 'index.md log.md'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'

  # GitHub Pages éƒ¨ç½²
  deploy-pages:
    if: |
      always() &&
      (needs.checkin.outputs.pages_updated == 'true' ||
       github.event_name == 'schedule' && github.event.schedule == '35 5,17 * * *' ||
       (github.event_name == 'workflow_dispatch' && (github.event.inputs.task_type == 'pages' || github.event.inputs.task_type == 'both')))
    needs: [checkin]
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    env:
      TZ: Asia/Shanghai
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ä»»åŠ¡æ‘˜è¦
  summary:
    if: always()
    needs: [checkin, deploy-pages]
    runs-on: ubuntu-latest
    steps:
      - name: Create workflow summary
        run: |
          echo "## ðŸš€ æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“‹ ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.checkin.result }}" == "success" ]; then
            echo "- âœ… **ç­¾åˆ°ä»»åŠ¡:** æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.checkin.result }}" == "failure" ]; then
            echo "- âŒ **ç­¾åˆ°ä»»åŠ¡:** å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.checkin.result }}" == "skipped" ]; then
            echo "- â­ï¸ **ç­¾åˆ°ä»»åŠ¡:** è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â¸ï¸ **ç­¾åˆ°ä»»åŠ¡:** å–æ¶ˆ" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.deploy-pages.result }}" == "success" ]; then
            echo "- âœ… **é¡µé¢éƒ¨ç½²:** æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-pages.result }}" == "failure" ]; then
            echo "- âŒ **é¡µé¢éƒ¨ç½²:** å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-pages.result }}" == "skipped" ]; then
            echo "- â­ï¸ **é¡µé¢éƒ¨ç½²:** è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â¸ï¸ **é¡µé¢éƒ¨ç½²:** å–æ¶ˆ" >> $GITHUB_STEP_SUMMARY
          fi 
